<!DOCTYPE html>
<html lang="en">
<head>
    <title id='Description'>Winelist
    </title>
    <link rel="stylesheet" href="js/jqwidgets/styles/jqx.base.css" type="text/css" />
    <script type="text/javascript" src="js/scripts/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxcore.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxdata.js"></script> 
    <script type="text/javascript" src="js/jqwidgets/jqxbuttons.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxscrollbar.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxmenu.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxgrid.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxgrid.edit.js"></script>  
    <script type="text/javascript" src="js/jqwidgets/jqxgrid.selection.js"></script> 
    <script type="text/javascript" src="js/jqwidgets/jqxlistbox.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxdropdownlist.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxcheckbox.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxcalendar.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxnumberinput.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxdatetimeinput.js"></script>
    <script type="text/javascript" src="js/jqwidgets/globalization/globalize.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxgrid.sort.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxgrid.filter.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxpanel.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxnumberinput.js"></script>
    <script type="text/javascript" src="js/jqwidgets/jqxgrid.columnsresize.js"></script> 
    <script type="text/javascript" src="js/jqwidgets/jqxgrid.columnsreorder.js"></script> 
    <script type="text/javascript" src="js/scripts/gettheme.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var theme = getDemoTheme();

            var url = "getwine.py/get"
            
            lastedit = null;
            edits = {};
            newrows = {};
            var source =
            {
                datatype: "json",
                datafields: [
                    { name: 'category',       type: 'string' },
                    { name: 'bin',            type: 'string' },
                    { name: 'listorder',      type: 'number' },
                    { name: 'byline',         type: 'string' },
                    { name: 'name',           type: 'string' },
                    { name: 'qtprice',        type: 'number' },
                    { name: 'frontprice',     type: 'float' },
                    { name: 'mynotes',        type: 'string' },
                    { name: 'grapes',         type: 'string' },
                    { name: 'supplier',       type: 'string' },
                    { name: 'notes',          type: 'string' },
                    { name: 'listprice',      type: 'number' },
                    { name: 'active',         type: 'boolean' },
                    { name: 'units_in_stock', type: 'number' },
                    { name: 'inventory_date', type: 'date' },
                    { name: 'estimated_units_remaining', type: 'string' },
                    { name: 'id', type: 'int' },
                ],
                url: url,
                //editurl: 'http://localhost/getwine.py/',
                updaterow: function (rowid, rowdata, commit) {
                    if (lastedit == null) return;
                    
                    isnewrow = (rowdata.id == undefined) 
                    if (isnewrow) {
                      if (!(rowid in newrows)) {
                        // first time edited,blank row now being
                        // used. Add new blank row
                        newrow();
                      }  
                      newrows[rowid] = rowdata;
                      row = newrows[rowid];
                    }  
                    else {
                      if (!(rowdata.id in edits)) {edits[rowdata.id] = {};}
                      edits[rowdata.id][lastedit.datafield] = lastedit.value;
                      row = edits[rowdata.id];
                    }   

                    commit(true);

                    if (lastedit.datafield == 'units_in_stock')
                    {
                      rowindex = lastedit.rowindex;
                      lastedit = null;
                      now = new Date();
                      $("#jqxgrid").jqxGrid('setcellvalue', rowindex, 'inventory_date', now);
                      row['inventory_date'] = now;
                    }  
                },
                deleterow: function (rowid, rowdata, commit) {
                },
            };
            var dataAdapter = new $.jqx.dataAdapter(source); 
            // create jqxgrid.
            $("#jqxgrid").jqxGrid(
            {
                columnsresize: true,
                columnsreorder: true,
                editable: true,
                width: 2000,
                height: 450,
                source: dataAdapter,
                theme: theme,
                selectionmode: 'multiplecellsadvanced',
                sortable: true,
                filterable: true,
                altrows: true,
                columns: [
                    { text: 'name',          datafield: 'name',  width:200},
                    { text: 'bin',           datafield: 'bin',             },
                    { text: 'supplier',      datafield: 'supplier'},
                    { text: 'estimated_units_remaining', datafield: 'estimated_units_remaining', editable: false}, 
                    { text: 'units_in_stock',datafield: 'units_in_stock', columntype: 'numberinput' },
                    { text: 'inventory_date',datafield: 'inventory_date', columntype: 'datetimeinput', cellsformat: 'yyyy-MM-dd'},
                    { text: 'category',      datafield: 'category',        },
                    { text: 'active',        datafield: 'active',         columntype: 'checkbox'},
                    { text: 'listprice',     datafield: 'listprice',      columntype: 'numberinput' },
                    { text: 'qtprice',       datafield: 'qtprice',        columntype: 'numberinput' },
                    { text: 'frontprice',    datafield: 'frontprice',     columntype: 'floatinput' },
                    { text: 'byline',        datafield: 'byline',         },
                    { text: 'grapes',        datafield: 'grapes',         },
                    { text: 'mynotes',       datafield: 'mynotes',        },
                    { text: 'notes',         datafield: 'notes',          },
                    { text: 'listorder',     datafield: 'listorder',      columntype: 'numberinput' },
                  /*{ text: 'Inv Date', datafield: 'inv_date', width: 100, cellsformat: 'yyyy-MM-dd', editable: false },
                  { text: 'Quantity', datafield: 'units', width: 70, align: 'right', cellsalign: 'right', columntype: 'numberinput'},
                  { text: 'bin', datafield: 'bin', width: 70, editable: true},
                  { text: 'Name', datafield: 'item_name', width: 250, editable: false},
                  { text: 'supplier', datafield: 'supplier' },
                  { text: 'listprice', datafield: 'listprice', width: 70, cellsalign: 'right', columntype: 'numberinput'},
                  { text: 'frontprice', datafield: 'frontprice', width: 70, cellsalign: 'right', columntype: 'numberinput'},
                  { text: 'byline', datafield: 'byline' },
                  { text: 'grapes', datafield: 'grapes' },
                  { text: 'mynotes', datafield: 'mynotes' },
                  { text: 'notes', datafield: 'notes'},*/
                ]
            });

            $("#jqxgrid").on('cellendedit', function (event) {
                lastedit = event.args;
            });

            // create new row.
            function newrow() {
                commit = $("#jqxgrid").jqxGrid('addrow', null, {});
            }


            $('#revieweditsbutton').jqxButton({ height: 25, theme: theme });
            $('#revieweditsbutton').click(function () {
            });
            $('#submiteditsbutton').jqxButton({ height: 25, theme: theme });
            $("#addrowbutton").jqxButton({ theme: theme });
            $('#submiteditsbutton').click(function () {
                doit = confirm(JSON.stringify(edits) + '\nNew rows:\n'+JSON.stringify(newrows));
                // synchronize with the server - send update command
                // call commit with parameter true if the synchronization with the server is successful 
                // and with parameter false if the synchronization failed.
                if (doit)
                {
                  $.ajax({
                    type: "POST",
                    dataType: "json",
                    url: "getwine.py/update_winelist",
                    data: {'edits' : JSON.stringify(edits), 'newrows':JSON.stringify(newrows)},
                    cache: false,
                    success: function (data, status, xhr) {
                        // update command is executed.
                        edits={};
                        newrows={};
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert(textStatus + ":::" + errorThrown + "\n" + jqXHR.responseText);
			errWindow = window.open("","MsgWindow","width=200,height=100");
                        errWindow.document.write("<p>"+textStatus + ":::" + errorThrown + "</p>" + jqXHR.responseText);
                        commit(false);
                    }
                  });
                }
            });
            //$('#events').jqxPanel({ width: 300, height: 80, theme: theme });
            //(rowid + " " + rowdata.name + " " + args.datafield+ " " + args.oldvalue + "-->" + args.value);

            $("#jqxgrid").on("bindingcomplete", function (event) {
            // add one blank row at the end to start for new wines to be entered. 
            // when that one is editted, we'll add another, and son on.
              newrow();
            });

            /*
                $("#events").jqxPanel('clearcontent');

                var sortinformation = event.args.sortinformation;
                var sortdirection = sortinformation.sortdirection.ascending ? "ascending" : "descending";
                if (!sortinformation.sortdirection.ascending && !sortinformation.sortdirection.descending) {
                    sortdirection = "null";
                }

                var eventData = "Triggered 'sort' event <div>Column:" + sortinformation.sortcolumn + ", Direction: " + sortdirection + "</div>";
                $('#events').jqxPanel('prepend', '<div style="margin-top: 5px;">' + eventData + '</div>');
            });

            $('#sortbackground').jqxCheckBox({checked: true, height: 25, theme: theme });
            // clear the sorting.
            $('#clearsortingbutton').click(function () {
                $("#jqxgrid").jqxGrid('removesort');
            });
            // show/hide sort background
            $('#sortbackground').on('change', function (event) {
                $("#jqxgrid").jqxGrid({ showsortcolumnbackground: event.args.checked });
            }); */
        });
    </script>
</head>
<body class='default'>
    <div id='jqxWidget' style="font-size: 13px; font-family: Verdana; float: left;">
        <center><input value="submit changes" id="submiteditsbutton" type="button" style='margin:20px' /></center>
        <div id="jqxgrid">
        </div>
    </div>
</body>
</html>
