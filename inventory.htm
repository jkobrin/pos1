<!DOCTYPE html>
<html lang="en">
<head>
    <style>
    body { width: 98%; text-align: center; background-color: blue;}
    </style>

    <title id='Description'>Inventory
    </title>
    <link rel="stylesheet" href="jq453/jqwidgets/styles/jqx.base.css" type="text/css" />
    <link rel="stylesheet" href="jq453/jqwidgets/styles/jqx.darkblue.css" type="text/css" />

    <script type="text/javascript" src="jq453/scripts/jquery-1.11.2.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxcore.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxdata.js"></script> 
    <script type="text/javascript" src="jq453/jqwidgets/jqxbuttons.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxscrollbar.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxmenu.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxgrid.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxgrid.edit.js"></script>  
    <script type="text/javascript" src="jq453/jqwidgets/jqxgrid.selection.js"></script> 
    <script type="text/javascript" src="jq453/jqwidgets/jqxgrid.grouping.js"></script> 
    <script type="text/javascript" src="jq453/jqwidgets/jqxlistbox.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxdropdownlist.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxcheckbox.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxcalendar.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxnumberinput.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxdatetimeinput.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/globalization/globalize.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxgrid.sort.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxgrid.filter.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxpanel.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxnumberinput.js"></script>
    <script type="text/javascript" src="jq453/jqwidgets/jqxgrid.columnsresize.js"></script> 
    <script type="text/javascript" src="jq453/jqwidgets/jqxgrid.columnsreorder.js"></script> 
    <script type="text/javascript">
        $(document).ready(function () {
            // supercategory should be the request parameters from the url
            var supercategory = window.location.search.match(/[^\?].*$/g);
            
            var theme = 'darkblue';

            lastedit = null;
            edits = {};
            newrows = {};
            var source =
            {
                datatype: "json",
                datafields: [
                    { name: 'name',           type: 'string' },
                    { name: 'supercategory',       type: 'string' },
                    { name: 'category',       type: 'string' },
                    { name: 'subcategory',       type: 'string' },
                    { name: 'retail_price',     type: 'float' },
                    { name: 'qtprice',        type: 'number' },
                    { name: 'scalable',        type: 'boolean' },
                    { name: 'add_on',        type: 'boolean' },
                    { name: 'tax',            type: 'string' },
                    { name: 'wholesale_price',      type: 'number' },
                    { name: 'supplier',       type: 'string' },
                    { name: 'bin',            type: 'string' },
                    { name: 'listorder',      type: 'number' },
                    { name: 'upc',         type: 'string' },
                    { name: 'description',         type: 'string' },
                    { name: 'active',         type: 'boolean' },
                    { name: 'units_in_stock', type: 'float' },
                    { name: 'inventory_date', type: 'date' },
                    { name: 'estimated_units_remaining', type: 'string' },
                    { name: 'mynotes',        type: 'string' },
                    { name: 'id', type: 'int' },
                ],
                url: "inventory.py/get_" + supercategory,
                //editurl: 'http://localhost/getwine.py/',
                updaterow: function (rowid, rowdata, commit) {
                    if (lastedit == null) return;
                    
                    isnewrow = (rowdata.id == undefined) 
                    if (isnewrow) {
                      if (!(rowid in newrows)) {
                        // first time edited,blank row now being
                        // used. Add new blank row
                        newrow();
                      }  
                      newrows[rowid] = rowdata;
                      row = newrows[rowid];
                    }  
                    else {
                      if (!(rowdata.id in edits)) {edits[rowdata.id] = {};}
                      edits[rowdata.id][lastedit.datafield] = lastedit.value;
                      row = edits[rowdata.id];
                    }   

                    commit(true);

                    if (lastedit.datafield == 'units_in_stock')
                    {
                      rowindex = lastedit.rowindex;
                      lastedit = null;
                      now = new Date();
                      $("#jqxgrid").jqxGrid('setcellvalue', rowindex, 'inventory_date', now);
                      row['inventory_date'] = now;
                    }  
                },
                deleterow: function (rowid, rowdata, commit) {
                },
            };
            var dataAdapter = new $.jqx.dataAdapter(source); 
            // create jqxgrid.
            $("#jqxgrid").jqxGrid(
            {
                columnsresize: true,
                columnsreorder: true,
                editable: true,
                width: '100%',
                height: 550,
                source: dataAdapter,
                theme: theme,
                selectionmode: 'multiplecellsadvanced',
                sortable: true,
                filterable: true,
                groupable: true,
                altrows: true,
                ready: function () {
                    $('#jqxgrid').jqxGrid('autoresizecolumns');
                    },
                columns: [
                    { text: 'category',    datafield: 'category', width:90  },
                    { text: 'name',       datafield: 'name',  width:210},
                    { text: 'bin',        datafield: 'bin', width:60  },
                    { text: 'listorder',  datafield: 'listorder',  columntype: 'numberinput' , width:60 },
                    { text: 'wholesale', datafield: 'wholesale_price', columntype: 'floatinput' , width: 60 },
                    { text: 'retail price',  datafield: 'retail_price',  columntype: 'numberinput' , width:60 },
                    { text: 'qtprice',    datafield: 'qtprice',    columntype: 'numberinput' , width: 60 },
                    { text: 'scalable',    datafield: 'scalable', columntype: 'checkbox', width: 30},
                    { text: 'add_on',    datafield: 'add_on', columntype: 'checkbox', width: 30},
                    { text: 'tax',  datafield: 'tax', width:90 },
                    { text: 'supplier',   datafield: 'supplier', width:90 },
                    { text: 'upc',   datafield: 'upc'},
                    { text: 'estimated_units_remaining', datafield: 'estimated_units_remaining', editable: false , width:90 }, 
                    { text: 'units_in_stock',datafield: 'units_in_stock', columntype: 'floatinput' , width:90 },
                    { text: 'inventory_date',datafield: 'inventory_date', columntype: 'datetimeinput', cellsformat: 'yyyy-MM-dd', width:90},
                    { text: 'subcategory', datafield: 'subcategory', width:60  },
                    { text: 'description',  datafield: 'description',   },
                    { text: 'mynotes', datafield: 'mynotes', width:150  },
                ]
            });

            $("#jqxgrid").on('cellendedit', function (event) {
                lastedit = event.args;
                //alert(lastedit);
            });

            $("#jqxgrid").bind('cellselect', function (event) {
              var row = event.args.rowindex;
              //alert(row);
              //$('#jqxgrid').jqxGrid('ensurerowvisible', row);

              //$('#' + row).jqxGrid('focus');
              //var col = event.args.datafield;
              //alert(row + ' ' + col);
              //var datarow = $("#jqxgrid").jqxGrid('getrowdata', row);
            });


            // create new row.
            function newrow() {

                //new rows will have the supercategory of row 0,
                //since we assume you can only edit one
                //supercategory at a time and the query will have
                //returned only things within one supercategory
                //and that this is the supercategory of thing you
                //now want to create as a new item
               
                var supercat = $("#jqxgrid").jqxGrid('getcellvalue', 0, 'supercategory');
                commit = $("#jqxgrid").jqxGrid('addrow', null, {supercategory: supercat});
            }


            $('#submiteditsbutton').jqxButton({ height: 25, theme: theme });
            $('#submiteditsbutton').click(function () {
                doit = confirm(JSON.stringify(edits) + '\nNew rows:\n'+JSON.stringify(newrows));
                // synchronize with the server - send update command
                // call commit with parameter true if the synchronization with the server is successful 
                // and with parameter false if the synchronization failed.
                if (doit)
                {
                  $.ajax({
                    type: "POST",
                    dataType: "json",
                    url: "inventory.py/update", // + "?supercategory="+supercategory,
                    data: {'edits' : JSON.stringify(edits), 'newrows':JSON.stringify(newrows)},
                    cache: false,
                    success: function (data, status, xhr) {
                        // update command is executed.
                        edits={};
                        newrows={};
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        document.write("<p>"+textStatus + ":::" + errorThrown + "</p>" + jqXHR.responseText)
                        alert(textStatus + ":::" + errorThrown + "\n" + jqXHR.responseText);
			                  errWindow = window.open("","MsgWindow","width=200,height=100");
                        errWindow.document.write("<p>"+textStatus + ":::" + errorThrown + "</p>" + jqXHR.responseText);
                        commit(false);
                    }
                  });
                }
            });
            $('#printinventorybutton').click(function () {
                  $.ajax({
                    type: "POST",
                    dataType: "json",
                    url: "print_wine_inventory.py",
                    data: {},
                    cache: false,
                    success: function (data, status, xhr) {
                        alert('print request sent')
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        //alert(textStatus + ":::" + errorThrown + "\n" + jqXHR.responseText);
                        document.write("<p>"+textStatus + ":::" + errorThrown + "</p>" + jqXHR.responseText)
			                  errWindow = window.open("","MsgWindow","width=200,height=100");
                        errWindow.document.write("<p>"+textStatus + ":::" + errorThrown + "</p>" + jqXHR.responseText);
                    }
                  });
            });
            //$('#events').jqxPanel({ width: 300, height: 80, theme: theme });
            //(rowid + " " + rowdata.name + " " + args.datafield+ " " + args.oldvalue + "-->" + args.value);

            $("#jqxgrid").on("bindingcomplete", function (event) {
            // add one blank row at the end to start for new
            // items to be entered. 
            // when that one is editted, we'll add another, and son on.
              newrow();
            });

            /*
                $("#events").jqxPanel('clearcontent');

                var sortinformation = event.args.sortinformation;
                var sortdirection = sortinformation.sortdirection.ascending ? "ascending" : "descending";
                if (!sortinformation.sortdirection.ascending && !sortinformation.sortdirection.descending) {
                    sortdirection = "null";
                }

                var eventData = "Triggered 'sort' event <div>Column:" + sortinformation.sortcolumn + ", Direction: " + sortdirection + "</div>";
                $('#events').jqxPanel('prepend', '<div style="margin-top: 5px;">' + eventData + '</div>');
            });

            $('#sortbackground').jqxCheckBox({checked: true, height: 25, theme: theme });
            // clear the sorting.
            $('#clearsortingbutton').click(function () {
                $("#jqxgrid").jqxGrid('removesort');
            });
            // show/hide sort background
            $('#sortbackground').on('change', function (event) {
                $("#jqxgrid").jqxGrid({ showsortcolumnbackground: event.args.checked });
            }); */
        });
    </script>
</head>
<body class='default'>
    <!--<div id='jqxWidget' style="font-size: 13px; font-family: Verdana; float: left; width: 98%; height: 100%; background-color: pink">-->
        <center><input value="submit changes" id="submiteditsbutton" type="button" style='margin:20px' />
        <input value="print inventory" id="printinventorybutton" type="button" style='margin:20px' /></center>
        <div id="jqxgrid">
        </div>
    <!--</div>-->
</body>
</html>
